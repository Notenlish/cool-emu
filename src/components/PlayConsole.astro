---
import Layout from "src/layouts/Layout.astro";
import { Label } from "$lib/components/ui/label";
import SaveIcon from "$assets/save.svg";
import GearIcon from "$assets/gear.svg";
import Image from "astro/components/Image.astro";
import { Input } from "$lib/components/ui/input";
import * as InputGroup from "$lib/components/ui/input-group/index.js";
interface Props {
    title: string;
    description: string;
    core: string;
    aspectRatioTailwind: string;
}

const { title, description, core, aspectRatioTailwind } = Astro.props;
---

<h1 class="text-3xl font-bold mb-6">
    Play {title} Games using Emulation
</h1>
<p>{description}</p>

<div
    id="enterGameData"
    class="flex flex-col w-full items-start gap-1.5 mb-12 max-w-200"
>
    <Label class={"text-base"} for="biosInput">Enter BIOS File(Optional):</Label
    >
    <InputGroup.Root class="mb-2">
        <InputGroup.Input class="leading-6" id="biosInput" type="file" />
        <InputGroup.Addon
            class={"p-0 m-0 w-12 h-12 min-w-12 size-12 text-black"}
        >
            <GearIcon width={64} height={64} class={"size-8"} />
        </InputGroup.Addon>
    </InputGroup.Root>
    <Label
        id="fileDrop"
        class={`text-base cursor-pointer w-full flex flex-col justify-center border-2 border-dashed border-olive-400 bg-neutral-100 rounded ${aspectRatioTailwind}`}
        for="romInput"
    >
        <div class="flex gap-2 w-full items-center justify-center">
            <InputGroup.Addon class={"p-0 m-0 size-12 text-black"}>
                <SaveIcon width={64} height={64} class={"size-8"} />
            </InputGroup.Addon>
            <span class="w-fit h-min">Enter Game File:</span>
            <Input
                class={`leading-6 max-w-60`}
                id="romInput"
                type="file"
                required
            />
        </div>
    </Label>
</div>

<div
    id="gameContainer"
    style="width:640px;height:480px;max-width:100%;display:none;"
>
    <div id="game"></div>
</div>

<div id="data-emulator" data-core={core}></div>
<script type="text/javascript">
    const input = document.getElementById("romInput");
    const biosInput = document.getElementById("biosInput");
    const fileDrop = document.getElementById("fileDrop");

    let data = {
        gameFile: "",
        biosFile: "",
    };

    biosInput.addEventListener("change", (e) => {
        const file = input.files[0];
        if (!file) {
            console.log("File not found!");
        } else {
            const blobUrl = URL.createObjectURL(file);
            data["biosFile"] = blobUrl;
        }
        checkValidAndStart();
    });

    input.addEventListener("change", (e) => {
        const file = input.files[0];
        if (!file) {
            console.log("File not found!");
        } else {
            const blobUrl = URL.createObjectURL(file);
            data["gameFile"] = blobUrl;
        }
        checkValidAndStart();
    });
    window.addEventListener("drop", (e) => {
        if ([...e.dataTransfer.items].some((item) => item.kind === "file")) {
            e.preventDefault();
        }
    });
    fileDrop.addEventListener("dragover", (e) => {
        const fileItems = [...e.dataTransfer.items].filter(
            (item) => items.kind === "file",
        );
        if (fileItems.length > 0) {
            e.preventDefault();
            e.dataTransfer.dropEffect = "copy";
        }
    });
    fileDrop.addEventListener("drop", (ev) => {
        ev.preventDefault();
        const files = [...ev.dataTransfer.items]
            .map((item) => item.getAsFile())
            .filter((file) => file);
        const blobUrl = URL.createObjectURL(files[0]);
        data["gameFile"] = blobUrl;
        checkValidAndStart();
    });
    window.addEventListener("dragover", (e) => {
        const fileItems = [...e.dataTransfer.items].filter(
            (item) => item.kind === "file",
        );
        if (fileItems.length > 0) {
            e.preventDefault();
            if (!dropZone.contains(e.target)) {
                e.dataTransfer.dropEffect = "none";
            }
        }
    });

    const checkValidAndStart = () => {
        if (data["gameFile"] === "") {
            return;
        }
        document.getElementById("enterGameData").style.display = "none";
        document.getElementById("gameContainer").style.display = "block";

        EJS_player = "#game";
        // Can also be fceumm or nestopia
        EJS_core = document.getElementById("data-emulator").dataset.core;

        // URL to BIOS file
        // EJS_biosUrl = "https://archive.org/download/disksys_202501/disksys.rom";
        EJS_biosUrl = data["biosFile"];

        /*
        File Name	    Description	                                                                                                md5sum
        disksys.rom	    Family Computer Disk System BIOS - Required for Famicom Disk System emulation	                            ca30b50f880eb660a320674ed365ef7a
        gamegenie.nes	Game Genie add-on cartridge - Required for Game Genie Add-on emulation (Only supported on the fceumm core)	7f98d77d7a094ad7d069b74bd553ec98
        */

        // URL to Game rom
        EJS_gameUrl = data["gameFile"];

        // Path to the data directory
        EJS_pathtodata = "data/";
        EJS_DEBUG_XX = true;
        // EJS_language = "tr";

        const scriptTag = document.createElement("script");
        scriptTag.src = "data/loader.js";
        document.body.appendChild(scriptTag);
    };
</script>

<!-- <script is:inline src="data/loader.js"></script> -->
